<!DOCTYPE html>
<html>
<head>
    <title>Mapbox-GL Map</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='lib/mapbox-gl-js/v0.34.0/mapbox-gl.css' rel='stylesheet'/>
    <style type="text/css">
        html, body, #map {
            margin: 0;
            height: 100%;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script type="text/javascript" src="../cordova.js"></script>
<script src='lib/mapbox-gl-js/v0.34.0/mapbox-gl.js'></script>
<script>

  // Specific 'fetch' polyfill for android platform
  // using HTML5 Fil    e API and cordova-plugin-file
  if (typeof cordova != 'undefined' && cordova.platformId == 'android') {
    var fetch = function (url) {
      var path = window.location.origin + window.location.pathname.split("/").slice(0,-1).join("/")+"/";
      return new Promise(function (resolve, reject) {
        window.resolveLocalFileSystemURL(path + url, function (fileEntry) {
          fileEntry.file(function (file) {
            var reader = new FileReader();
            reader.onload = function (e) {
              var text = e.target.result;
              var jsonPromise = new Promise(function (resolve, reject) {
                try {
                  console.log(text);
                  resolve(JSON.parse(text));
                } catch (e) {
                  reject(e);
                }
              });
              resolve({
                json: function() {
                  return jsonPromise;
                }
              });
            };
            reader.onerror = function (e) {
              reject(e);
            };
            reader.readAsText(file, 'UTF-8');
          });
        }, function (error) {
          reject(error);
        });
      });
    };
  }

  var map = new mapboxgl.Map({
    container: 'map',
    style: 'styles/positron.json',
    hash: true
  });

  var nav = new mapboxgl.NavigationControl();
  map.addControl(nav, 'top-right');

  var overlays = [{
    name: "LINIES_METRO",
    style: {
      "id": "linia_style",
      "type": "line",
      "source": "LINIES_METRO",
      "layout": {
        "line-join": "round",
        "line-cap": "round"
      },
      "paint": {
        "line-color": {
          "property": "COLOR_LINIA",
          "type": "categorical",
          "stops": [
            ['CE1126', '#CE1126'],
            ['93248F', '#93248F'],
            ['1EB53A', '#1EB53A'],
            ['F7A30E', '#F7A30E'],
            ['00A6D6', '#00A6D6'],
            ['004C38', '#004C38'],
            ['005A97', '#005A97'],
            ['89B94C', '#89B94C'],
            ['FB712B', '#FB712B']
          ]
        },
        "line-width": 4
      }
    }
  },{
    name: "EST_LINIA_CENTRAL",
    style: {
      "id": "estacio_style",
      "type": "symbol",
      "source": "EST_LINIA_CENTRAL",
      "layout": {
        "icon-image": "{PICTO}",
        "icon-size": 0.28,
        "text-field": "{NOM_ESTACIO}",
        "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
        "text-offset": [0.8, 0],
        "text-anchor": "left",
        "text-size": 14
      },
      "paint": {
        "text-halo-width": 2,
        "text-halo-color": "#FFFFFF"
      }
    }
  }];

  function addLayers() {
    overlays.map(addLayer);
  }

  function addLayer(layer) {
    if (layer.data) {
      map.addSource(layer.name, {
        "type": "geojson",
        "data": layer.data
      });
      map.addLayer(layer.style);
    }
  }

  map.on('load', function () {
      var getLayerData = function (layer) {
          return fetch('data/' + layer.name + '.geojson').then(function (response) {
              return response.json().then(function (data) {
                  layer.data = data;
                  return layer;
              });
          });
      };

      Promise.all(overlays.map(getLayerData)).then(addLayers);
  });

</script>
</body>
</html>
